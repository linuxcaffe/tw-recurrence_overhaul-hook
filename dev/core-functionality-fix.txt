Summary: Fixing Recurrence Core Functionality
The Problem
The recurrence system's core functionality (spawning first instance on template creation) was broken. When adding a recurring task, the template was created but no instance spawned.
Root Causes Discovered
1. The update_rlast Parameter Issue
Problem: spawn_instance() always updated template's rlast, even during respawn operations where it should stay unchanged.
Impact: Confused the distinction between:

Spawn (on-exit): Create next instance, INCREMENT rlast
Respawn (on-modify): Replace current instance, PRESERVE rlast

Solution: Added update_rlast parameter to spawn_instance():
pythondef spawn_instance(template, rindex, completion_time=None, update_rlast=True):

on-exit calls: update_rlast=True (normal spawn)
on-modify calls: update_rlast=False (respawn)

2. Taskwarrior's Built-in Recurrence Fields
Problem: Even with recurrence=no, Taskwarrior automatically adds internal fields when it sees r: attribute:

rtype (always set to "periodic")
rdate (internal tracking)
rperiod (internal period)

Impact: spawn_instance() was copying rtype:periodic to instances, causing Taskwarrior to reject the task creation with error: "The 'rtype' attribute does not allow a value of 'periodic'"
Solution: Added Taskwarrior's recurrence fields to skip_fields:
pythonskip_fields = {
    # ... standard fields ...
    'rtype',    # Taskwarrior sets this automatically
    'rdate',    # Taskwarrior internal tracking
    'rperiod',  # Taskwarrior internal period
    # ... our fields ...
}
3. Python .pyc Cache Hell ðŸ”¥
Problem: Python caches compiled bytecode in __pycache__/. Even after updating .py files, Python was executing OLD cached versions.
Impact: We added rtype to skip_fields, but the hook kept copying it because Python was running the cached old code!
Solution: Always clear cache after updating hooks:
bashrm -rf ~/.task/hooks/__pycache__
Prevention: Set permanently in ~/.bashrc or ~/.zshrc:
bashexport PYTHONDONTWRITEBYTECODE=1
Key Architectural Insights
Spawn vs Respawn Separation

Spawn creates the NEXT instance (rlast increments)
Respawn replaces the CURRENT instance (rlast unchanged)
Using update_rlast parameter cleanly separates these concerns

UDA Preservation Philosophy
The recurrence system must be a transparent wrapper that:

âœ… Preserves ALL user UDAs (edate, pri, custom fields)
âœ… Only skips fields it MUST skip (recurrence-internal, Taskwarrior-internal)
âœ… Never assumes what's valid/invalid (let Taskwarrior validate)
âœ… "Smart coding over quick fixes" - understand before changing

The Hook System's Safety Net
spawn_instance() uses rc.hooks=off when modifying templates, which:

Prevents cascade triggers (on-modify doesn't fire from spawn's rlast updates)
Provides clean separation between user actions and hook-internal operations
Is the KEY to preventing infinite loops

What We Fixed
Files Modified

recurrence_common_hook.py (v0.5.0)

Added update_rlast parameter to spawn_instance()
Added Taskwarrior fields to skip_fields (rtype, rdate, rperiod)
Added debug logging of command execution
Added check_instance_count() function


on-add_recurrence.py

Respawn calls use update_rlast=False
Childless template spawn uses update_rlast=False


on-exit_recurrence.py

Normal spawn calls use update_rlast=True
First instance spawn uses update_rlast=True



Lessons for Future Development
1. Always Clear Python Cache
After ANY hook update:
bashrm -rf ~/.task/hooks/__pycache__
2. Debug Before Assuming

Enable DEBUG_RECURRENCE=1
Read debug logs carefully
The error messages tell you exactly what's wrong

3. Respect the Separation of Concerns

on-add: Creates templates
on-exit: Spawns instances (normal flow)
on-modify: Respawns instances (recalculation)
Each has a clear role; don't mix responsibilities

4. Trust But Verify

Taskwarrior does things even with features "disabled"
Always check what fields actually exist in JSON export
Never assume field names without verification

5. Preserve User Data

The recurrence system is infrastructure, not policy
Copy ALL UDAs except what you MUST skip
Let Taskwarrior validate, don't second-guess users

Final Status
âœ… Core functionality restored
âœ… Templates spawn first instance on creation
âœ… Instances spawn next instance on completion
âœ… All user UDAs preserved (edate, priority, custom fields)
âœ… Taskwarrior internal fields properly skipped
âœ… Clean spawn/respawn separation maintained
Ready for further testing: respawn on modifications, time machine, chain vs period types, etc.
